<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VisualWall V2 – Demo</title>
  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial; margin: 20px auto; max-width: 780px; padding: 0 12px; }
    header { display:flex; align-items:center; justify-content:space-between; gap: var(--gap); margin-bottom: 16px; }
    h1 { font-size: 1.4rem; margin: 0; }
    .row { display:flex; gap: var(--gap); align-items: center; flex-wrap: wrap; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    input[type="text"] { flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; min-width: 220px; }
    .muted { color: #666; }
    .card { border: 1px solid #e5e5e5; border-radius: 14px; padding: 12px; margin: 10px 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
    .notice { background: #fff9e6; border: 1px solid #ffe08a; padding: 10px 12px; border-radius: 10px; margin: 10px 0; }
    .ok { background: #eefaf0; border: 1px solid #cdebd1; }
    footer { margin: 24px 0 40px; font-size: .9rem; color:#666; }
  </style>
</head>
<body>
  <header>
    <h1>VisualWall V2 – Demo</h1>
    <div class="row">
      <button id="connect">Conectar wallet</button>
      <div id="account" class="muted"></div>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <input id="newPost" type="text" placeholder="Escribí tu post…" />
      <button id="sendPost" disabled>Publicar</button>
    </div>
    <div id="status" class="muted" style="margin-top:8px;"></div>
  </div>

  <div class="notice">
    <div>Red objetivo: <strong>Sepolia</strong> (ChainId <span class="mono">11155111</span>)</div>
    <div>Contrato: <code id="addr" class="mono"></code></div>
  </div>

  <div id="list"></div>

  <footer>
    <div class="muted">Consejo: si no ves tus posts, verificá estar en <strong>Sepolia</strong>, que el contrato sea el correcto y que la transacción esté confirmada.</div>
  </footer>

  <!-- Ethers v6 desde CDN. Necesitás conexión a internet para cargar esta librería. -->
  <script type="module">
  import { BrowserProvider, Contract } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.min.js";

  const CONTRACT_ADDRESS = "0xa4f64573d3f5b51d65498c3fd4645f35515de4bb";

  // ABI “ultra-compatible” para V2
  const ABI = [
    // eventos
    "event PostCreated(uint256 indexed id, address indexed author, uint256 timestamp, string message)",
    // escritura
    "function createPost(string _message) public",
    // lecturas base
    "function getPostsCount() view returns (uint256)",
    // rango de posts (struct sin 'deleted', sin nombres — más tolerante)
    "function getPostsRange(uint256 start, uint256 limit) view returns (tuple(uint256,string,address,uint256)[])",
    // por si existe getPost en tu V2
    "function getPost(uint256 id) view returns (uint256,string,address,uint256)"
  ];


    const sepoliaId = 11155111n;

    const addrEl = document.getElementById('addr');
    const connectBtn = document.getElementById('connect');
    const sendBtn = document.getElementById('sendPost');
    const newPostEl = document.getElementById('newPost');
    const statusEl = document.getElementById('status');
    const accountEl = document.getElementById('account');
    const listEl = document.getElementById('list');

    addrEl.textContent = CONTRACT_ADDRESS;

    let provider, signer, contract;

    function uiStatus(msg, ok=false) {
      statusEl.textContent = msg || "";
      statusEl.className = ok ? "muted ok" : "muted";
    }

    function escapeHtml(s) {
      return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    async function ensureSepolia() {
      const net = await provider.getNetwork();
      if (net.chainId !== sepoliaId) {
        uiStatus("⚠️ Estás en otra red. Cambiando a Sepolia…");
        try {
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: "0xaa36a7" }] // 11155111 en hex
          });
          uiStatus("✅ Red cambiada a Sepolia", true);
        } catch (e) {
          uiStatus("No se pudo cambiar la red automáticamente. Seleccioná Sepolia en MetaMask.");
          throw e;
        }
      }
    }

    async function connect() {
      if (!window.ethereum) { alert("Instalá MetaMask para continuar"); return; }
      provider = new BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      await ensureSepolia();
      signer = await provider.getSigner();
      contract = new Contract(CONTRACT_ADDRESS, ABI, signer);
      accountEl.textContent = await signer.getAddress();
      sendBtn.disabled = false;
      await load(true);

      // Refrescar en vivo cuando haya nuevos posts
      try {
        contract.on("PostCreated", async () => { await load(true); });
      } catch {}
    }

      async function load(scrollTop=false) {
    listEl.innerHTML = "<div class='muted'>Cargando posts…</div>";
    try {
      const totalBN = await contract.getPostsCount();
      const total = Number(totalBN);
      const page = 50;
      const start = Math.max(0, total - page);

      let items = [];

      // Intento 1: usar getPostsRange (rápido)
      try {
        const arr = await contract.getPostsRange(start, page);
        // Ethers v6 devuelve objetos/arrays; normalizo
        items = arr.map((p, idx) => {
          const id = Number((p.id ?? p[0] ?? (start + idx)));
          const message = String(p.message ?? p[1] ?? "");
          const author = String(p.author ?? p[2] ?? "0x");
          const timestamp = Number(p.timestamp ?? p[3] ?? 0);
          return { id, message, author, timestamp };
        });
      } catch (e) {
        console.warn("getPostsRange falló, usando fallback getPost(i)", e);
        // Intento 2: leer uno por uno
        for (let i = start; i < total; i++) {
          try {
            const p = await contract.getPost(i);
            const id = Number(p.id ?? p[0] ?? i);
            const message = String(p.message ?? p[1] ?? "");
            const author = String(p.author ?? p[2] ?? "0x");
            const timestamp = Number(p.timestamp ?? p[3] ?? 0);
            items.push({ id, message, author, timestamp });
          } catch {}
        }
      }

      items.sort((a,b) => b.id - a.id);

      listEl.innerHTML = "";
      for (const p of items) {
        const div = document.createElement("div");
        div.className = "card";
        const safeMsg = p.message.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
        div.innerHTML = `
          <div><strong>#${p.id}</strong> – ${new Date(p.timestamp*1000).toLocaleString()}</div>
          <div>${safeMsg}</div>
          <small class="muted">by ${p.author}</small>
        `;
        listEl.appendChild(div);
      }

      if (scrollTop) window.scrollTo({ top: 0, behavior: "smooth" });
      uiStatus("");
    } catch (err) {
      console.error(err);
      uiStatus("No se pudieron cargar los posts. Verificá el address del contrato y la red.");
    }
  }


    async function publish() {
      const msg = newPostEl.value.trim();
      if (!msg) { uiStatus("Escribí un mensaje antes de publicar"); return; }
      try {
        sendBtn.disabled = true;
        uiStatus("Enviando transacción…");
        const tx = await contract.createPost(msg);
        uiStatus("Esperando confirmación…");
        await tx.wait();
        newPostEl.value = "";
        uiStatus("✅ Publicado", true);
        await load(true);
      } catch (e) {
        console.error(e);
        uiStatus("❌ Transacción rechazada o fallida");
      } finally {
        sendBtn.disabled = false;
      }
    }

    connectBtn.addEventListener('click', connect);
    sendBtn.addEventListener('click', publish);
  </script>
</body>
</html>
